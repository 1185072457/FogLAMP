#!/bin/bash

check_classic

if [ `pg_status | grep -c "no server running"` -gt 0 ]; then

  echo "It looks like the FogLAMP Storage Layer is not running."

else

  echo -n "Stopping the FogLAMP Storage Layer, please wait..."

  # Set the LD_LIBRARY_PATH variable
  if [ `uname -m` == "armv7l" ]; then
    LD_LIBRARY_PATH=/usr/local/pgsql/lib:/usr/local/pgsql/lib/arm-linux-gnueabihf
    export LD_LIBRARY_PATH
  fi

  /usr/local/pgsql/bin/pg_ctl -w -D /usr/local/pgsql/data stop > /dev/null

  cycle=30
  while [ "$cycle" -gt 0 ]; do
    if [ `pg_status | grep -c "no server running"` -gt 0 ]; then
      echo "Done."
      cycle=0
    else
      if [ "$cycle" -eq 1 ]; then
        echo "FogLAMP cannot be initialized."
        exit 3
      else
        echo -n "."
        cycle=$((cycle -1))
        sleep 1
      fi
    fi
  done

fi 

exit 0
